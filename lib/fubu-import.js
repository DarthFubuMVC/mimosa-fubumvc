"use strict";
var Rx, buildExtensions, cleanAssets, color, copyFile, cwd, deleteFile, excludeStrategies, findSourceFiles, fs, importAssets, isExcludedByConfig, log, parseString, parseXml, path, prepareFileWatcher, shouldInclude, startWatching, transformPath, watch, withoutPath, wrench, _;

log = require('./util').log;

color = require('ansi-color').set;

fs = require('fs');

path = require('path');

watch = require('chokidar');

wrench = require('wrench');

_ = require('lodash');

parseString = require('xml2js').parseString;

cwd = process.cwd();

Rx = require("rx");

findSourceFiles = function(from, extensions, excludes) {
  return wrench.readdirSyncRecursive(from).filter(function(f) {
    var isFile, isIncluded;
    isFile = fs.statSync(f).isFile();
    isIncluded = shouldInclude(f, isFile, extensions, excludes);
    return isIncluded && isFile;
  });
};

shouldInclude = function(f, isFile, extensions, excludes) {
  var atRoot, excluded, ext, matchesExtension;
  extensions = extensions.map(function(ext) {
    return "." + ext;
  });
  ext = path.extname(f);
  matchesExtension = !isFile || _.contains(extensions, ext);
  atRoot = isFile && f.indexOf(path.sep) === -1;
  excluded = isExcludedByConfig(f, excludes);
  return matchesExtension && !excluded && !atRoot;
};

withoutPath = function(fromPath) {
  return function(input) {
    return input.replace("" + fromPath + path.sep, '');
  };
};

prepareFileWatcher = function(from, extensions, excludes, isBuild) {
  var adds, changes, errors, files, fixPath, numberOfFiles, observableFor, unlinks, watchSettings, watcher;
  files = findSourceFiles(from, extensions, excludes);
  numberOfFiles = files.length;
  fixPath = withoutPath(from);
  watchSettings = {
    ignored: function(file) {
      var f, isFile;
      isFile = fs.statSync(file).isFile();
      f = fixPath(file);
      return !(shouldInclude(f, isFile, extensions, excludes));
    },
    persistent: !isBuild,
    usePolling: true,
    interval: 500,
    binaryInterval: 1000
  };
  observableFor = function(event) {
    return Rx.Observable.fromEvent(watcher, event);
  };
  watcher = watch.watch(from, watchSettings);
  adds = observableFor("add");
  changes = observableFor("change");
  unlinks = observableFor("unlink");
  errors = (observableFor("error")).selectMany(function(e) {
    return Rx.Observable["throw"](e);
  });
  return {
    numberOfFiles: numberOfFiles,
    adds: adds,
    changes: changes,
    unlinks: unlinks,
    errors: errors
  };
};

startWatching = function(from, _arg, options, cb) {
  var adds, changes, deletes, errors, fixPath, fromSource, initialCopy, numberOfFiles, unlinks;
  numberOfFiles = _arg.numberOfFiles, adds = _arg.adds, changes = _arg.changes, unlinks = _arg.unlinks, errors = _arg.errors;
  fixPath = withoutPath(from);
  fromSource = function(obs) {
    return obs.merge(errors).map(fixPath);
  };
  initialCopy = fromSource(adds).take(numberOfFiles);
  initialCopy.subscribe(function(f) {
    return copyFile(f, options);
  }, function(e) {
    log("warn", "File watching error: " + e);
    if (cb) {
      return cb();
    }
  }, function() {
    var ongoingCopy;
    ongoingCopy = fromSource(adds.merge(changes));
    ongoingCopy.subscribe(function(f) {
      return copyFile(f, options);
    }, function(e) {
      return log("warn", "File watching error: " + e);
    });
    if (cb) {
      return cb();
    }
  });
  deletes = fromSource(unlinks);
  return deletes.subscribe(function(f) {
    return deleteFile(f, options);
  }, function(e) {
    return log("warn", "File watching errors: " + e);
  });
};

copyFile = function(file, options) {
  return fs.readFile(file, function(err, data) {
    var dirname, outFile;
    if (err) {
      log("error", "Error reading file [[ " + file + " ]], " + err);
      return;
    }
    outFile = transformPath(file, options);
    dirname = path.dirname(outFile);
    if (!fs.existsSync(dirname)) {
      wrench.mkdirSyncRecursive(dirname, 0x1ff);
    }
    return fs.writeFile(outFile, data, function(err) {
      if (err) {
        return log("error", "Error reading file [[ " + file + " ]], " + err);
      } else {
        return log("success", "File copied to destination [[ " + outFile + " ]].");
      }
    });
  });
};

deleteFile = function(file, options) {
  var outFile;
  outFile = transformPath(file, options);
  return fs.exists(outFile, function(exists) {
    if (exists) {
      return fs.unlink(outFile, function(err) {
        if (err) {
          return log("error", "Error deleting file [[ " + outFile + " ]], " + err);
        } else {
          return log("success", "File [[ " + outFile + " ]] deleted.");
        }
      });
    }
  });
};

transformPath = function(file, _arg) {
  var conventions, result, sourceDir;
  sourceDir = _arg.sourceDir, conventions = _arg.conventions;
  result = _.reduce(conventions, function(acc, _arg1) {
    var ext, match, transform;
    match = _arg1.match, transform = _arg1.transform;
    ext = path.extname(acc);
    if (match(acc, ext)) {
      return transform(acc, path);
    } else {
      return acc;
    }
  }, file);
  return path.join(sourceDir, result);
};

excludeStrategies = {
  string: {
    identity: _.isString,
    predicate: function(ex, path) {
      return path.indexOf(ex) === 0;
    }
  },
  regex: {
    identity: _.isRegExp,
    predicate: function(ex, path) {
      return ex.test(path);
    }
  }
};

isExcludedByConfig = function(path, excludes) {
  var ofType;
  ofType = function(method) {
    return excludes.filter(function(f) {
      return method(f);
    });
  };
  return _.any(excludeStrategies, function(_arg) {
    var identity, predicate;
    identity = _arg.identity, predicate = _arg.predicate;
    return _.any(ofType(identity), function(ex) {
      return predicate(ex, path);
    });
  });
};

parseXml = function(filePath) {
  var contents, result;
  contents = fs.readFileSync(filePath);
  result = {};
  parseString(contents, function(err, output) {
    return result = output;
  });
  return result;
};

buildExtensions = function(config) {
  var copy, css, extensions, javascript, _ref;
  _ref = config.extensions, copy = _ref.copy, javascript = _ref.javascript, css = _ref.css;
  return extensions = _.union(copy, javascript, css);
};

importAssets = function(mimosaConfig, options, next) {
  var compiledDir, conventions, excludePaths, extensions, fileWatcher, isBuild, sourceDir, _ref;
  _ref = mimosaConfig.fubumvc, extensions = _ref.extensions, excludePaths = _ref.excludePaths, sourceDir = _ref.sourceDir, compiledDir = _ref.compiledDir, isBuild = _ref.isBuild, conventions = _ref.conventions;
  extensions = buildExtensions(mimosaConfig);
  log("debug", "importing assets");
  log("debug", "allowed extensions [[ " + extensions + " ]]");
  log("debug", "excludePaths [[ " + excludePaths + " ]]");
  fileWatcher = prepareFileWatcher(cwd, extensions, excludePaths, isBuild);
  return startWatching(cwd, fileWatcher, {
    sourceDir: sourceDir,
    conventions: conventions
  }, next);
};

cleanAssets = function(mimosaConfig, options, next) {
  return next();
};

module.exports = {
  importAssets: importAssets,
  cleanAssets: cleanAssets
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYzpcXGhvbWVcXGdpdGh1YlxcbWltb3NhLWZ1YnVtdmNcXGxpYlxcZnVidS1pbXBvcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjOlxcaG9tZVxcZ2l0aHViXFxtaW1vc2EtZnVidW12Y1xcc3JjXFxmdWJ1LWltcG9ydC5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBQSxDQUFBO0FBQUEsSUFBQSw4UUFBQTs7QUFBQSxNQUVRLE9BQUEsQ0FBUSxRQUFSLEVBQVAsR0FGRCxDQUFBOztBQUFBLEtBR0EsR0FBUSxPQUFBLENBQVEsWUFBUixDQUFxQixDQUFDLEdBSDlCLENBQUE7O0FBQUEsRUFJQSxHQUFLLE9BQUEsQ0FBUSxJQUFSLENBSkwsQ0FBQTs7QUFBQSxJQUtBLEdBQU8sT0FBQSxDQUFRLE1BQVIsQ0FMUCxDQUFBOztBQUFBLEtBTUEsR0FBUSxPQUFBLENBQVEsVUFBUixDQU5SLENBQUE7O0FBQUEsTUFPQSxHQUFTLE9BQUEsQ0FBUSxRQUFSLENBUFQsQ0FBQTs7QUFBQSxDQVFBLEdBQUksT0FBQSxDQUFRLFFBQVIsQ0FSSixDQUFBOztBQUFBLFdBU0EsR0FBYyxPQUFBLENBQVEsUUFBUixDQUFpQixDQUFDLFdBVGhDLENBQUE7O0FBQUEsR0FVQSxHQUFNLE9BQU8sQ0FBQyxHQUFSLENBQUEsQ0FWTixDQUFBOztBQUFBLEVBV0EsR0FBSyxPQUFBLENBQVEsSUFBUixDQVhMLENBQUE7O0FBQUEsZUFhQSxHQUFrQixTQUFDLElBQUQsRUFBTyxVQUFQLEVBQW1CLFFBQW5CLEdBQUE7U0FDaEIsTUFBTSxDQUFDLG9CQUFQLENBQTRCLElBQTVCLENBQ0UsQ0FBQyxNQURILENBQ1UsU0FBQyxDQUFELEdBQUE7QUFDTixRQUFBLGtCQUFBO0FBQUEsSUFBQSxNQUFBLEdBQVMsRUFBRSxDQUFDLFFBQUgsQ0FBWSxDQUFaLENBQWMsQ0FBQyxNQUFmLENBQUEsQ0FBVCxDQUFBO0FBQUEsSUFDQSxVQUFBLEdBQWEsYUFBQSxDQUFj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QSxVQUFELEVBQWEsb0JBQUEsWUFBYixFQUEyQixpQkFBQSxTQUEzQixFQUFzQyxtQkFBQSxXQUF0QyxFQUFtRCxlQUFBLE9BQW5ELEVBQTRELG1CQUFBLFdBQTVELENBQUE7QUFBQSxFQUdBLFVBQUEsR0FBYSxlQUFBLENBQWdCLFlBQWhCLENBSGIsQ0FBQTtBQUFBLEVBS0EsR0FBQSxDQUFJLE9BQUosRUFBYSxrQkFBYixDQUxBLENBQUE7QUFBQSxFQU1BLEdBQUEsQ0FBSSxPQUFKLEVBQWMsd0JBQUEsR0FBdUIsVUFBdkIsR0FBbUMsS0FBakQsQ0FOQSxDQUFBO0FBQUEsRUFPQSxHQUFBLENBQUksT0FBSixFQUFjLGtCQUFBLEdBQWlCLFlBQWpCLEdBQStCLEtBQTdDLENBUEEsQ0FBQTtBQUFBLEVBU0EsV0FBQSxHQUFjLGtCQUFBLENBQW1CLEdBQW5CLEVBQXdCLFVBQXhCLEVBQW9DLFlBQXBDLEVBQWtELE9BQWxELENBVGQsQ0FBQTtTQVVBLGFBQUEsQ0FBYyxHQUFkLEVBQW1CLFdBQW5CLEVBQWdDO0FBQUEsSUFBQyxXQUFBLFNBQUQ7QUFBQSxJQUFZLGFBQUEsV0FBWjtHQUFoQyxFQUEwRCxJQUExRCxFQVhhO0FBQUEsQ0EzSmYsQ0FBQTs7QUFBQSxXQTBLQSxHQUFjLFNBQUMsWUFBRCxFQUFlLE9BQWYsRUFBd0IsSUFBeEIsR0FBQTtTQUNaLElBQUEsQ0FBQSxFQURZO0FBQUEsQ0ExS2QsQ0FBQTs7QUFBQSxNQTZLTSxDQUFDLE9BQVAsR0FBaUI7QUFBQSxFQUFDLGNBQUEsWUFBRDtBQUFBLEVBQWUsYUFBQSxXQUFmO0NBN0tqQixDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCJcclxuXHJcbntsb2d9ID0gcmVxdWlyZSAnLi91dGlsJ1xyXG5jb2xvciA9IHJlcXVpcmUoJ2Fuc2ktY29sb3InKS5zZXRcclxuZnMgPSByZXF1aXJlICdmcydcclxucGF0aCA9IHJlcXVpcmUgJ3BhdGgnXHJcbndhdGNoID0gcmVxdWlyZSAnY2hva2lkYXInXHJcbndyZW5jaCA9IHJlcXVpcmUgJ3dyZW5jaCdcclxuXyA9IHJlcXVpcmUgJ2xvZGFzaCdcclxucGFyc2VTdHJpbmcgPSByZXF1aXJlKCd4bWwyanMnKS5wYXJzZVN0cmluZ1xyXG5jd2QgPSBwcm9jZXNzLmN3ZCgpXHJcblJ4ID0gcmVxdWlyZSBcInJ4XCJcclxuXHJcbmZpbmRTb3VyY2VGaWxlcyA9IChmcm9tLCBleHRlbnNpb25zLCBleGNsdWRlcykgLT5cclxuICB3cmVuY2gucmVhZGRpclN5bmNSZWN1cnNpdmUoZnJvbSlcclxuICAgIC5maWx0ZXIgKGYpIC0+XHJcbiAgICAgIGlzRmlsZSA9IGZzLnN0YXRTeW5jKGYpLmlzRmlsZSgpXHJcbiAgICAgIGlzSW5jbHVkZWQgPSBzaG91bGRJbmNsdWRlIGYsIGlzRmlsZSwgZXh0ZW5zaW9ucywgZXhjbHVkZXNcclxuICAgICAgaXNJbmNsdWRlZCBhbmQgaXNGaWxlXHJcblxyXG5zaG91bGRJbmNsdWRlID0gKGYsIGlzRmlsZSwgZXh0ZW5zaW9ucywgZXhjbHVkZXMpIC0+XHJcbiAgI1RPRE86IG9ubHkgYWRkcyB0aGUgLiB0byB5b3UgZm9yIGV4dGVuc2lvbnMgaWYgaXRzIGxlZnQgb2ZmXHJcbiAgZXh0ZW5zaW9ucyA9IGV4dGVuc2lvbnMubWFwIChleHQpIC0+IFwiLiN7ZXh0fVwiXHJcbiAgZXh0ID0gcGF0aC5leHRuYW1lIGZcclxuICBtYXRjaGVzRXh0ZW5zaW9uID0gbm90IGlzRmlsZSBvciBfLmNvbnRhaW5zIGV4dGVuc2lvbnMsIGV4dFxyXG4gIGF0Um9vdCA9IGlzRmlsZSBhbmQgZi5pbmRleE9mKHBhdGguc2VwKSA9PSAtMVxyXG4gIGV4Y2x1ZGVkID0gaXNFeGNsdWRlZEJ5Q29uZmlnIGYsIGV4Y2x1ZGVzXHJcbiAgbWF0Y2hlc0V4dGVuc2lvbiBhbmQgbm90IGV4Y2x1ZGVkIGFuZCBub3QgYXRSb290XHJcblxyXG53aXRob3V0UGF0aCA9IChmcm9tUGF0aCkgLT5cclxuICAoaW5wdXQpIC0+IGlucHV0LnJlcGxhY2UgXCIje2Zyb21QYXRofSN7cGF0aC5zZXB9XCIsICcnXHJcblxyXG5wcmVwYXJlRmlsZVdhdGNoZXIgPSAoZnJvbSwgZXh0ZW5zaW9ucywgZXhjbHVkZXMsIGlzQnVpbGQpIC0+XHJcbiAgI1RPRE86IG5vIG1vcmUgc3luYyBjYWxsc1xyXG4gIGZpbGVzICA9IGZpbmRTb3VyY2VGaWxlcyBmcm9tLCBleHRlbnNpb25zLCBleGNsdWRlc1xyXG4gIG51bWJlck9mRmlsZXMgID0gZmlsZXMubGVuZ3RoXHJcbiAgZml4UGF0aCA9IHdpdGhvdXRQYXRoIGZyb21cclxuXHJcbiAgd2F0Y2hTZXR0aW5ncyA9XHJcbiAgICBpZ25vcmVkOiAoZmlsZSkgLT5cclxuICAgICAgaXNGaWxlID0gZnMuc3RhdFN5bmMoZmlsZSkuaXNGaWxlKClcclxuICAgICAgZiA9IGZpeFBhdGggZmlsZVxyXG4gICAgICBub3QgKHNob3VsZEluY2x1ZGUgZiwgaXNGaWxlLCBleHRlbnNpb25zLCBleGNsdWRlcylcclxuICAgIHBlcnNpc3RlbnQ6IG5vdCBpc0J1aWxkXHJcbiAgICB1c2VQb2xsaW5nOiB0cnVlXHJcbiAgICBpbnRlcnZhbDogNTAwXHJcbiAgICBiaW5hcnlJbnRlcnZhbDogMTAwMFxyXG5cclxuICBvYnNlcnZhYmxlRm9yID0gKGV2ZW50KSAtPlxyXG4gICAgUnguT2JzZXJ2YWJsZS5mcm9tRXZlbnQgd2F0Y2hlciwgZXZlbnRcclxuXHJcbiAgd2F0Y2hlciA9IHdhdGNoLndhdGNoIGZyb20sIHdhdGNoU2V0dGluZ3NcclxuICBhZGRzID0gb2JzZXJ2YWJsZUZvciBcImFkZFwiXHJcbiAgY2hhbmdlcyA9IG9ic2VydmFibGVGb3IgXCJjaGFuZ2VcIlxyXG4gIHVubGlua3MgPSBvYnNlcnZhYmxlRm9yIFwidW5saW5rXCJcclxuICBlcnJvcnMgPSAob2JzZXJ2YWJsZUZvciBcImVycm9yXCIpLnNlbGVjdE1hbnkgKGUpIC0+IFJ4Lk9ic2VydmFibGUudGhyb3cgZVxyXG4gIHtudW1iZXJPZkZpbGVzLCBhZGRzLCBjaGFuZ2VzLCB1bmxpbmtzLCBlcnJvcnN9XHJcblxyXG5zdGFydFdhdGNoaW5nID0gKFxyXG4gIGZyb20sXHJcbiAge251bWJlck9mRmlsZXMsIGFkZHMsIGNoYW5nZXMsIHVubGlua3MsIGVycm9yc30sXHJcbiAgb3B0aW9ucyxcclxuICBjYikgLT5cclxuXHJcbiAgZml4UGF0aCA9IHdpdGhvdXRQYXRoIGZyb21cclxuXHJcbiAgZnJvbVNvdXJjZSA9IChvYnMpIC0+XHJcbiAgICBvYnMubWVyZ2UoZXJyb3JzKS5tYXAgZml4UGF0aFxyXG5cclxuICBpbml0aWFsQ29weSA9IGZyb21Tb3VyY2UoYWRkcylcclxuICAgIC50YWtlKG51bWJlck9mRmlsZXMpXHJcblxyXG4gIGluaXRpYWxDb3B5LnN1YnNjcmliZShcclxuICAgIChmKSAtPlxyXG4gICAgICBjb3B5RmlsZSBmLCBvcHRpb25zXHJcbiAgICAoZSkgLT5cclxuICAgICAgbG9nIFwid2FyblwiLCBcIkZpbGUgd2F0Y2hpbmcgZXJyb3I6ICN7ZX1cIlxyXG4gICAgICBjYigpIGlmIGNiXHJcbiAgICAoKSAtPlxyXG4gICAgICBvbmdvaW5nQ29weSA9IGZyb21Tb3VyY2UoYWRkcy5tZXJnZSBjaGFuZ2VzKVxyXG4gICAgICBvbmdvaW5nQ29weS5zdWJzY3JpYmUoXHJcbiAgICAgICAgKGYpIC0+IGNvcHlGaWxlIGYsIG9wdGlvbnNcclxuICAgICAgICAoZSkgLT4gbG9nIFwid2FyblwiLCBcIkZpbGUgd2F0Y2hpbmcgZXJyb3I6ICN7ZX1cIlxyXG4gICAgICApXHJcbiAgICAgIGNiKCkgaWYgY2JcclxuICApXHJcblxyXG4gIGRlbGV0ZXMgPSBmcm9tU291cmNlKHVubGlua3MpXHJcblxyXG4gIGRlbGV0ZXMuc3Vic2NyaWJlKFxyXG4gICAgKGYpIC0+IGRlbGV0ZUZpbGUgZiwgb3B0aW9uc1xyXG4gICAgKGUpIC0+IGxvZyBcIndhcm5cIiwgXCJGaWxlIHdhdGNoaW5nIGVycm9yczogI3tlfVwiXHJcbiAgKVxyXG5cclxuY29weUZpbGUgPSAoZmlsZSwgb3B0aW9ucykgLT5cclxuICBmcy5yZWFkRmlsZSBmaWxlLCAoZXJyLCBkYXRhKSAtPlxyXG4gICAgaWYgZXJyXHJcbiAgICAgIGxvZyBcImVycm9yXCIsIFwiRXJyb3IgcmVhZGluZyBmaWxlIFtbICN7ZmlsZX0gXV0sICN7ZXJyfVwiXHJcbiAgICAgIHJldHVyblxyXG5cclxuICAgIG91dEZpbGUgPSB0cmFuc2Zvcm1QYXRoIGZpbGUsIG9wdGlvbnNcclxuXHJcbiAgICBkaXJuYW1lID0gcGF0aC5kaXJuYW1lIG91dEZpbGVcclxuICAgIHVubGVzcyBmcy5leGlzdHNTeW5jIGRpcm5hbWVcclxuICAgICAgd3JlbmNoLm1rZGlyU3luY1JlY3Vyc2l2ZSBkaXJuYW1lLCAwbzA3NzdcclxuXHJcbiAgICBmcy53cml0ZUZpbGUgb3V0RmlsZSwgZGF0YSwgKGVycikgLT5cclxuICAgICAgaWYgZXJyXHJcbiAgICAgICAgbG9nIFwiZXJyb3JcIiwgXCJFcnJvciByZWFkaW5nIGZpbGUgW1sgI3tmaWxlfSBdXSwgI3tlcnJ9XCJcclxuICAgICAgZWxzZVxyXG4gICAgICAgIGxvZyBcInN1Y2Nlc3NcIiwgXCJGaWxlIGNvcGllZCB0byBkZXN0aW5hdGlvbiBbWyAje291dEZpbGV9IF1dLlwiXHJcblxyXG5kZWxldGVGaWxlID0gKGZpbGUsIG9wdGlvbnMpIC0+XHJcbiAgb3V0RmlsZSA9IHRyYW5zZm9ybVBhdGggZmlsZSwgb3B0aW9uc1xyXG4gIGZzLmV4aXN0cyBvdXRGaWxlLCAoZXhpc3RzKSAtPlxyXG4gICAgaWYgZXhpc3RzXHJcbiAgICAgIGZzLnVubGluayBvdXRGaWxlLCAoZXJyKSAtPlxyXG4gICAgICAgIGlmIGVyclxyXG4gICAgICAgICAgbG9nIFwiZXJyb3JcIiwgXCJFcnJvciBkZWxldGluZyBmaWxlIFtbICN7b3V0RmlsZX0gXV0sICN7ZXJyfVwiXHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgICAgbG9nIFwic3VjY2Vzc1wiLCBcIkZpbGUgW1sgI3tvdXRGaWxlfSBdXSBkZWxldGVkLlwiXHJcblxyXG50cmFuc2Zvcm1QYXRoID0gKGZpbGUsIHtzb3VyY2VEaXIsIGNvbnZlbnRpb25zfSkgLT5cclxuICByZXN1bHQgPSBfLnJlZHVjZShjb252ZW50aW9ucywgKGFjYywge21hdGNoLCB0cmFuc2Zvcm19KSAtPlxyXG4gICAgZXh0ID0gcGF0aC5leHRuYW1lIGFjY1xyXG4gICAgaWYgbWF0Y2ggYWNjLCBleHQgdGhlbiB0cmFuc2Zvcm0gYWNjLCBwYXRoIGVsc2UgYWNjXHJcbiAgLCBmaWxlKVxyXG4gIHBhdGguam9pbiBzb3VyY2VEaXIsIHJlc3VsdFxyXG5cclxuZXhjbHVkZVN0cmF0ZWdpZXMgPVxyXG4gIHN0cmluZzpcclxuICAgIGlkZW50aXR5OiBfLmlzU3RyaW5nXHJcbiAgICBwcmVkaWNhdGU6IChleCwgcGF0aCkgLT4gcGF0aC5pbmRleE9mKGV4KSA9PSAwXHJcbiAgcmVnZXg6XHJcbiAgICBpZGVudGl0eTogXy5pc1JlZ0V4cFxyXG4gICAgcHJlZGljYXRlOiAoZXgsIHBhdGgpIC0+IGV4LnRlc3QgcGF0aFxyXG5cclxuaXNFeGNsdWRlZEJ5Q29uZmlnID0gKHBhdGgsIGV4Y2x1ZGVzKSAtPlxyXG4gIG9mVHlwZSA9IChtZXRob2QpIC0+XHJcbiAgICBleGNsdWRlcy5maWx0ZXIgKGYpIC0+IG1ldGhvZChmKVxyXG5cclxuICBfLmFueSBleGNsdWRlU3RyYXRlZ2llcywgKHtpZGVudGl0eSwgcHJlZGljYXRlfSkgLT5cclxuICAgIF8uYW55IChvZlR5cGUgaWRlbnRpdHkpLCAoZXgpIC0+IHByZWRpY2F0ZSBleCwgcGF0aFxyXG5cclxucGFyc2VYbWwgPSAoZmlsZVBhdGgpIC0+XHJcbiAgY29udGVudHMgPSBmcy5yZWFkRmlsZVN5bmMgZmlsZVBhdGhcclxuICByZXN1bHQgPSB7fVxyXG4gIHBhcnNlU3RyaW5nIGNvbnRlbnRzLCAoZXJyLCBvdXRwdXQpIC0+XHJcbiAgICByZXN1bHQgPSBvdXRwdXRcclxuICByZXN1bHRcclxuXHJcbmJ1aWxkRXh0ZW5zaW9ucyA9IChjb25maWcpIC0+XHJcbiAge2NvcHksIGphdmFzY3JpcHQsIGNzc30gPSBjb25maWcuZXh0ZW5zaW9uc1xyXG4gIGV4dGVuc2lvbnMgPSBfLnVuaW9uIGNvcHksIGphdmFzY3JpcHQsIGNzc1xyXG5cclxuaW1wb3J0QXNzZXRzID0gKG1pbW9zYUNvbmZpZywgb3B0aW9ucywgbmV4dCkgLT5cclxuICB7ZXh0ZW5zaW9ucywgZXhjbHVkZVBhdGhzLCBzb3VyY2VEaXIsIGNvbXBpbGVkRGlyLCBpc0J1aWxkLCBjb252ZW50aW9uc30gPVxyXG4gICAgbWltb3NhQ29uZmlnLmZ1YnVtdmNcclxuXHJcbiAgZXh0ZW5zaW9ucyA9IGJ1aWxkRXh0ZW5zaW9ucyBtaW1vc2FDb25maWdcclxuXHJcbiAgbG9nIFwiZGVidWdcIiwgXCJpbXBvcnRpbmcgYXNzZXRzXCJcclxuICBsb2cgXCJkZWJ1Z1wiLCBcImFsbG93ZWQgZXh0ZW5zaW9ucyBbWyAje2V4dGVuc2lvbnN9IF1dXCJcclxuICBsb2cgXCJkZWJ1Z1wiLCBcImV4Y2x1ZGVQYXRocyBbWyAje2V4Y2x1ZGVQYXRoc30gXV1cIlxyXG5cclxuICBmaWxlV2F0Y2hlciA9IHByZXBhcmVGaWxlV2F0Y2hlciBjd2QsIGV4dGVuc2lvbnMsIGV4Y2x1ZGVQYXRocywgaXNCdWlsZFxyXG4gIHN0YXJ0V2F0Y2hpbmcgY3dkLCBmaWxlV2F0Y2hlciwge3NvdXJjZURpciwgY29udmVudGlvbnN9LCBuZXh0XHJcbiAgI1RPRE86IGdhdGhlciBzb3VyY2VzXHJcbiAgIy5saW5rcywgd2lsbCB1c2UgcGFyc2VYbWwgZm9yIHRoaXNcclxuXHJcbmNsZWFuQXNzZXRzID0gKG1pbW9zYUNvbmZpZywgb3B0aW9ucywgbmV4dCkgLT5cclxuICBuZXh0KClcclxuXHJcbm1vZHVsZS5leHBvcnRzID0ge2ltcG9ydEFzc2V0cywgY2xlYW5Bc3NldHN9XHJcbiJdfQ==
