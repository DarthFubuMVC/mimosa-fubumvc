"use strict";
var Rx, buildExtensions, cleanAssets, color, copyFile, cwd, deleteDirectory, deleteFile, deleteFileSync, excludeStrategies, findSourceFiles, fs, importAssets, isExcludedByConfig, log, parseString, parseXml, path, prepareFileWatcher, shouldInclude, startWatching, transformPath, watch, withoutPath, wrench, _;

log = require('./util').log;

color = require('ansi-color').set;

fs = require('fs');

path = require('path');

watch = require('chokidar');

wrench = require('wrench');

_ = require('lodash');

parseString = require('xml2js').parseString;

cwd = process.cwd();

Rx = require("rx");

findSourceFiles = function(from, extensions, excludes) {
  return wrench.readdirSyncRecursive(from).filter(function(f) {
    var isFile, isIncluded;
    isFile = fs.statSync(f).isFile();
    isIncluded = shouldInclude(f, isFile, extensions, excludes);
    return isIncluded && isFile;
  });
};

shouldInclude = function(f, isFile, extensions, excludes) {
  var atRoot, excluded, ext, matchesExtension;
  extensions = extensions.map(function(ext) {
    return "." + ext;
  });
  ext = path.extname(f);
  matchesExtension = !isFile || _.contains(extensions, ext);
  atRoot = isFile && f.indexOf(path.sep) === -1;
  excluded = isExcludedByConfig(f, excludes);
  return matchesExtension && !excluded && !atRoot;
};

withoutPath = function(fromPath) {
  return function(input) {
    return input.replace("" + fromPath + path.sep, '');
  };
};

prepareFileWatcher = function(from, extensions, excludes, isBuild) {
  var adds, changes, errors, files, fixPath, numberOfFiles, observableFor, unlinks, watchSettings, watcher;
  files = findSourceFiles(from, extensions, excludes);
  numberOfFiles = files.length;
  fixPath = withoutPath(from);
  watchSettings = {
    ignored: function(file) {
      var f, isFile;
      isFile = fs.statSync(file).isFile();
      f = fixPath(file);
      return !(shouldInclude(f, isFile, extensions, excludes));
    },
    persistent: !isBuild,
    usePolling: true,
    interval: 500,
    binaryInterval: 1000
  };
  observableFor = function(event) {
    return Rx.Observable.fromEvent(watcher, event);
  };
  watcher = watch.watch(from, watchSettings);
  adds = observableFor("add");
  changes = observableFor("change");
  unlinks = observableFor("unlink");
  errors = (observableFor("error")).selectMany(function(e) {
    return Rx.Observable["throw"](e);
  });
  return {
    numberOfFiles: numberOfFiles,
    adds: adds,
    changes: changes,
    unlinks: unlinks,
    errors: errors
  };
};

startWatching = function(from, _arg, options, cb) {
  var adds, changes, deletes, errors, fixPath, fromSource, initialCopy, numberOfFiles, unlinks;
  numberOfFiles = _arg.numberOfFiles, adds = _arg.adds, changes = _arg.changes, unlinks = _arg.unlinks, errors = _arg.errors;
  fixPath = withoutPath(from);
  fromSource = function(obs) {
    return obs.merge(errors).map(fixPath);
  };
  initialCopy = fromSource(adds).take(numberOfFiles);
  initialCopy.subscribe(function(f) {
    return copyFile(f, options);
  }, function(e) {
    log("warn", "File watching error: " + e);
    if (cb) {
      return cb();
    }
  }, function() {
    var ongoingCopy;
    ongoingCopy = fromSource(adds.merge(changes));
    ongoingCopy.subscribe(function(f) {
      return copyFile(f, options);
    }, function(e) {
      return log("warn", "File watching error: " + e);
    });
    if (cb) {
      return cb();
    }
  });
  deletes = fromSource(unlinks);
  return deletes.subscribe(function(f) {
    var outFile;
    outFile = transformPath(f, options);
    return deleteFile(outFile);
  }, function(e) {
    return log("warn", "File watching errors: " + e);
  });
};

copyFile = function(file, options) {
  return fs.readFile(file, function(err, data) {
    var dirname, outFile;
    if (err) {
      log("error", "Error reading file [[ " + file + " ]], " + err);
      return;
    }
    outFile = transformPath(file, options);
    dirname = path.dirname(outFile);
    if (!fs.existsSync(dirname)) {
      wrench.mkdirSyncRecursive(dirname, 0x1ff);
    }
    return fs.writeFile(outFile, data, function(err) {
      if (err) {
        return log("error", "Error reading file [[ " + file + " ]], " + err);
      } else {
        return log("success", "File copied to destination [[ " + outFile + " ]].");
      }
    });
  });
};

deleteFileSync = function(file) {
  if (fs.existsSync(file)) {
    fs.unlinkSync(file);
    return log("success", "File [[ " + file + " ]] deleted.");
  }
};

deleteFile = function(file) {
  return fs.exists(file, function(exists) {
    if (exists) {
      return fs.unlink(file, function(err) {
        if (err) {
          return log("error", "Error deleting file [[ " + file + " ]], " + err);
        } else {
          return log("success", "File [[ " + file + " ]] deleted.");
        }
      });
    }
  });
};

deleteDirectory = function(dir, cb) {
  if (fs.existsSync(dir)) {
    return fs.rmdir(dir, function(err) {
      if ((err != null ? err.code : void 0) === !"ENOTEMPTY") {
        log("error", "Unable to delete directory [[ " + dir + " ]]");
        log("error", err);
      } else {
        log("info", "Deleted empty directory [[ " + dir + " ]]");
      }
      if (cb) {
        return cb();
      }
    });
  } else {
    if (cb) {
      return cb();
    }
  }
};

transformPath = function(file, _arg) {
  var conventions, result, sourceDir;
  sourceDir = _arg.sourceDir, conventions = _arg.conventions;
  result = _.reduce(conventions, function(acc, _arg1) {
    var ext, match, transform;
    match = _arg1.match, transform = _arg1.transform;
    ext = path.extname(acc);
    if (match(acc, ext)) {
      return transform(acc, path);
    } else {
      return acc;
    }
  }, file);
  return path.join(sourceDir, result);
};

excludeStrategies = {
  string: {
    identity: _.isString,
    predicate: function(ex, path) {
      return path.indexOf(ex) === 0;
    }
  },
  regex: {
    identity: _.isRegExp,
    predicate: function(ex, path) {
      return ex.test(path);
    }
  }
};

isExcludedByConfig = function(path, excludes) {
  var ofType;
  ofType = function(method) {
    return excludes.filter(function(f) {
      return method(f);
    });
  };
  return _.any(excludeStrategies, function(_arg) {
    var identity, predicate;
    identity = _arg.identity, predicate = _arg.predicate;
    return _.any(ofType(identity), function(ex) {
      return predicate(ex, path);
    });
  });
};

parseXml = function(filePath) {
  var contents, result;
  contents = fs.readFileSync(filePath);
  result = {};
  parseString(contents, function(err, output) {
    return result = output;
  });
  return result;
};

buildExtensions = function(config) {
  var copy, css, extensions, javascript, _ref;
  _ref = config.extensions, copy = _ref.copy, javascript = _ref.javascript, css = _ref.css;
  return extensions = _.union(copy, javascript, css);
};

importAssets = function(mimosaConfig, options, next) {
  var compiledDir, conventions, excludePaths, extensions, fileWatcher, isBuild, sourceDir, _ref;
  _ref = mimosaConfig.fubumvc, excludePaths = _ref.excludePaths, sourceDir = _ref.sourceDir, compiledDir = _ref.compiledDir, isBuild = _ref.isBuild, conventions = _ref.conventions;
  extensions = buildExtensions(mimosaConfig);
  log("debug", "importing assets");
  log("debug", "allowed extensions [[ " + extensions + " ]]");
  log("debug", "excludePaths [[ " + excludePaths + " ]]");
  fileWatcher = prepareFileWatcher(cwd, extensions, excludePaths, isBuild);
  return startWatching(cwd, fileWatcher, {
    sourceDir: sourceDir,
    conventions: conventions
  }, next);
};

cleanAssets = function(mimosaConfig, options, next) {
  var compiledDir, conventions, dirs, done, excludePaths, extensions, files, isBuild, outputFiles, remainingDirs, sourceDir, _ref;
  _ref = mimosaConfig.fubumvc, extensions = _ref.extensions, excludePaths = _ref.excludePaths, sourceDir = _ref.sourceDir, compiledDir = _ref.compiledDir, isBuild = _ref.isBuild, conventions = _ref.conventions;
  extensions = buildExtensions(mimosaConfig);
  options = {
    sourceDir: sourceDir,
    conventions: conventions
  };
  files = findSourceFiles(cwd, extensions, excludePaths);
  outputFiles = _.map(files, function(f) {
    return transformPath(f, options);
  });
  _.each(outputFiles, function(f) {
    return deleteFileSync(f);
  });
  dirs = _(files).map(function(f) {
    return transformPath(f, options);
  }).map(function(f) {
    return path.dirname(f);
  }).sortBy("length").reverse().value();
  remainingDirs = [].concat(dirs);
  done = function(dir) {
    remainingDirs = _.without(remainingDirs, dir);
    if (remainingDirs.length === 0) {
      return next();
    }
  };
  return _(dirs).map(function(dir) {
    return [
      dir, function() {
        return done(dir);
      }
    ];
  }).each(function(_arg) {
    var cb, dir;
    dir = _arg[0], cb = _arg[1];
    return deleteDirectory(dir, cb);
  });
};

module.exports = {
  importAssets: importAssets,
  cleanAssets: cleanAssets
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYzpcXGhvbWVcXGdpdGh1YlxcbWltb3NhLWZ1YnVtdmNcXGxpYlxcZnVidS1pbXBvcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjOlxcaG9tZVxcZ2l0aHViXFxtaW1vc2EtZnVidW12Y1xcc3JjXFxmdWJ1LWltcG9ydC5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBQSxDQUFBO0FBQUEsSUFBQSwrU0FBQTs7QUFBQSxNQUVRLE9BQUEsQ0FBUSxRQUFSLEVBQVAsR0FGRCxDQUFBOztBQUFBLEtBR0EsR0FBUSxPQUFBLENBQVEsWUFBUixDQUFxQixDQUFDLEdBSDlCLENBQUE7O0FBQUEsRUFJQSxHQUFLLE9BQUEsQ0FBUSxJQUFSLENBSkwsQ0FBQTs7QUFBQSxJQUtBLEdBQU8sT0FBQSxDQUFRLE1BQVIsQ0FMUCxDQUFBOztBQUFBLEtBTUEsR0FBUSxPQUFBLENBQVEsVUFBUixDQU5SLENBQUE7O0FBQUEsTUFPQSxHQUFTLE9BQUEsQ0FBUSxRQUFSLENBUFQsQ0FBQTs7QUFBQSxDQVFBLEdBQUksT0FBQSxDQUFRLFFBQVIsQ0FSSixDQUFBOztBQUFBLFdBU0EsR0FBYyxPQUFBLENBQVEsUUFBUixDQUFpQixDQUFDLFdBVGhDLENBQUE7O0FBQUEsR0FVQSxHQUFNLE9BQU8sQ0FBQyxHQUFSLENBQUEsQ0FWTixDQUFBOztBQUFBLEVBV0EsR0FBSyxPQUFBLENBQVEsSUFBUixDQVhMLENBQUE7O0FBQUEsZUFhQSxHQUFrQixTQUFDLElBQUQsRUFBTyxVQUFQLEVBQW1CLFFBQW5CLEdBQUE7U0FDaEIsTUFBTSxDQUFDLG9CQUFQLENBQTRCLElBQTVCLENBQ0UsQ0FBQyxNQURILENBQ1UsU0FBQyxDQUFELEdBQUE7QUFDTixRQUFBLGtCQUFBO0FBQUEsSUFBQSxNQUFBLEdBQVMsRUFBRSxDQUFDLFFBQUgsQ0FBWSxDQUFaLENBQWMsQ0FBQyxNQUFmLENBQUEsQ0FBVCxDQUFBO0FBQUEsSUFDQSxVQUFBLEdBQWEsYUFBQSxDQUFj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V0FBZjtDQXpOakIsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiXHJcblxyXG57bG9nfSA9IHJlcXVpcmUgJy4vdXRpbCdcclxuY29sb3IgPSByZXF1aXJlKCdhbnNpLWNvbG9yJykuc2V0XHJcbmZzID0gcmVxdWlyZSAnZnMnXHJcbnBhdGggPSByZXF1aXJlICdwYXRoJ1xyXG53YXRjaCA9IHJlcXVpcmUgJ2Nob2tpZGFyJ1xyXG53cmVuY2ggPSByZXF1aXJlICd3cmVuY2gnXHJcbl8gPSByZXF1aXJlICdsb2Rhc2gnXHJcbnBhcnNlU3RyaW5nID0gcmVxdWlyZSgneG1sMmpzJykucGFyc2VTdHJpbmdcclxuY3dkID0gcHJvY2Vzcy5jd2QoKVxyXG5SeCA9IHJlcXVpcmUgXCJyeFwiXHJcblxyXG5maW5kU291cmNlRmlsZXMgPSAoZnJvbSwgZXh0ZW5zaW9ucywgZXhjbHVkZXMpIC0+XHJcbiAgd3JlbmNoLnJlYWRkaXJTeW5jUmVjdXJzaXZlKGZyb20pXHJcbiAgICAuZmlsdGVyIChmKSAtPlxyXG4gICAgICBpc0ZpbGUgPSBmcy5zdGF0U3luYyhmKS5pc0ZpbGUoKVxyXG4gICAgICBpc0luY2x1ZGVkID0gc2hvdWxkSW5jbHVkZSBmLCBpc0ZpbGUsIGV4dGVuc2lvbnMsIGV4Y2x1ZGVzXHJcbiAgICAgIGlzSW5jbHVkZWQgYW5kIGlzRmlsZVxyXG5cclxuc2hvdWxkSW5jbHVkZSA9IChmLCBpc0ZpbGUsIGV4dGVuc2lvbnMsIGV4Y2x1ZGVzKSAtPlxyXG4gICNUT0RPOiBvbmx5IGFkZHMgdGhlIC4gdG8geW91IGZvciBleHRlbnNpb25zIGlmIGl0cyBsZWZ0IG9mZlxyXG4gIGV4dGVuc2lvbnMgPSBleHRlbnNpb25zLm1hcCAoZXh0KSAtPiBcIi4je2V4dH1cIlxyXG4gIGV4dCA9IHBhdGguZXh0bmFtZSBmXHJcbiAgbWF0Y2hlc0V4dGVuc2lvbiA9IG5vdCBpc0ZpbGUgb3IgXy5jb250YWlucyBleHRlbnNpb25zLCBleHRcclxuICBhdFJvb3QgPSBpc0ZpbGUgYW5kIGYuaW5kZXhPZihwYXRoLnNlcCkgPT0gLTFcclxuICBleGNsdWRlZCA9IGlzRXhjbHVkZWRCeUNvbmZpZyBmLCBleGNsdWRlc1xyXG4gIG1hdGNoZXNFeHRlbnNpb24gYW5kIG5vdCBleGNsdWRlZCBhbmQgbm90IGF0Um9vdFxyXG5cclxud2l0aG91dFBhdGggPSAoZnJvbVBhdGgpIC0+XHJcbiAgKGlucHV0KSAtPiBpbnB1dC5yZXBsYWNlIFwiI3tmcm9tUGF0aH0je3BhdGguc2VwfVwiLCAnJ1xyXG5cclxucHJlcGFyZUZpbGVXYXRjaGVyID0gKGZyb20sIGV4dGVuc2lvbnMsIGV4Y2x1ZGVzLCBpc0J1aWxkKSAtPlxyXG4gICNUT0RPOiBubyBtb3JlIHN5bmMgY2FsbHNcclxuICBmaWxlcyAgPSBmaW5kU291cmNlRmlsZXMgZnJvbSwgZXh0ZW5zaW9ucywgZXhjbHVkZXNcclxuICBudW1iZXJPZkZpbGVzICA9IGZpbGVzLmxlbmd0aFxyXG4gIGZpeFBhdGggPSB3aXRob3V0UGF0aCBmcm9tXHJcblxyXG4gIHdhdGNoU2V0dGluZ3MgPVxyXG4gICAgaWdub3JlZDogKGZpbGUpIC0+XHJcbiAgICAgIGlzRmlsZSA9IGZzLnN0YXRTeW5jKGZpbGUpLmlzRmlsZSgpXHJcbiAgICAgIGYgPSBmaXhQYXRoIGZpbGVcclxuICAgICAgbm90IChzaG91bGRJbmNsdWRlIGYsIGlzRmlsZSwgZXh0ZW5zaW9ucywgZXhjbHVkZXMpXHJcbiAgICBwZXJzaXN0ZW50OiBub3QgaXNCdWlsZFxyXG4gICAgdXNlUG9sbGluZzogdHJ1ZVxyXG4gICAgaW50ZXJ2YWw6IDUwMFxyXG4gICAgYmluYXJ5SW50ZXJ2YWw6IDEwMDBcclxuXHJcbiAgb2JzZXJ2YWJsZUZvciA9IChldmVudCkgLT5cclxuICAgIFJ4Lk9ic2VydmFibGUuZnJvbUV2ZW50IHdhdGNoZXIsIGV2ZW50XHJcblxyXG4gIHdhdGNoZXIgPSB3YXRjaC53YXRjaCBmcm9tLCB3YXRjaFNldHRpbmdzXHJcbiAgYWRkcyA9IG9ic2VydmFibGVGb3IgXCJhZGRcIlxyXG4gIGNoYW5nZXMgPSBvYnNlcnZhYmxlRm9yIFwiY2hhbmdlXCJcclxuICB1bmxpbmtzID0gb2JzZXJ2YWJsZUZvciBcInVubGlua1wiXHJcbiAgZXJyb3JzID0gKG9ic2VydmFibGVGb3IgXCJlcnJvclwiKS5zZWxlY3RNYW55IChlKSAtPiBSeC5PYnNlcnZhYmxlLnRocm93IGVcclxuICB7bnVtYmVyT2ZGaWxlcywgYWRkcywgY2hhbmdlcywgdW5saW5rcywgZXJyb3JzfVxyXG5cclxuc3RhcnRXYXRjaGluZyA9IChcclxuICBmcm9tLFxyXG4gIHtudW1iZXJPZkZpbGVzLCBhZGRzLCBjaGFuZ2VzLCB1bmxpbmtzLCBlcnJvcnN9LFxyXG4gIG9wdGlvbnMsXHJcbiAgY2IpIC0+XHJcblxyXG4gIGZpeFBhdGggPSB3aXRob3V0UGF0aCBmcm9tXHJcblxyXG4gIGZyb21Tb3VyY2UgPSAob2JzKSAtPlxyXG4gICAgb2JzLm1lcmdlKGVycm9ycykubWFwIGZpeFBhdGhcclxuXHJcbiAgaW5pdGlhbENvcHkgPSBmcm9tU291cmNlKGFkZHMpXHJcbiAgICAudGFrZShudW1iZXJPZkZpbGVzKVxyXG5cclxuICBpbml0aWFsQ29weS5zdWJzY3JpYmUoXHJcbiAgICAoZikgLT5cclxuICAgICAgY29weUZpbGUgZiwgb3B0aW9uc1xyXG4gICAgKGUpIC0+XHJcbiAgICAgIGxvZyBcIndhcm5cIiwgXCJGaWxlIHdhdGNoaW5nIGVycm9yOiAje2V9XCJcclxuICAgICAgY2IoKSBpZiBjYlxyXG4gICAgKCkgLT5cclxuICAgICAgb25nb2luZ0NvcHkgPSBmcm9tU291cmNlKGFkZHMubWVyZ2UgY2hhbmdlcylcclxuICAgICAgb25nb2luZ0NvcHkuc3Vic2NyaWJlKFxyXG4gICAgICAgIChmKSAtPiBjb3B5RmlsZSBmLCBvcHRpb25zXHJcbiAgICAgICAgKGUpIC0+IGxvZyBcIndhcm5cIiwgXCJGaWxlIHdhdGNoaW5nIGVycm9yOiAje2V9XCJcclxuICAgICAgKVxyXG4gICAgICBjYigpIGlmIGNiXHJcbiAgKVxyXG5cclxuICBkZWxldGVzID0gZnJvbVNvdXJjZSh1bmxpbmtzKVxyXG5cclxuICBkZWxldGVzLnN1YnNjcmliZShcclxuICAgIChmKSAtPlxyXG4gICAgICBvdXRGaWxlID0gdHJhbnNmb3JtUGF0aCBmLCBvcHRpb25zXHJcbiAgICAgIGRlbGV0ZUZpbGUgb3V0RmlsZVxyXG4gICAgKGUpIC0+IGxvZyBcIndhcm5cIiwgXCJGaWxlIHdhdGNoaW5nIGVycm9yczogI3tlfVwiXHJcbiAgKVxyXG5cclxuY29weUZpbGUgPSAoZmlsZSwgb3B0aW9ucykgLT5cclxuICBmcy5yZWFkRmlsZSBmaWxlLCAoZXJyLCBkYXRhKSAtPlxyXG4gICAgaWYgZXJyXHJcbiAgICAgIGxvZyBcImVycm9yXCIsIFwiRXJyb3IgcmVhZGluZyBmaWxlIFtbICN7ZmlsZX0gXV0sICN7ZXJyfVwiXHJcbiAgICAgIHJldHVyblxyXG5cclxuICAgIG91dEZpbGUgPSB0cmFuc2Zvcm1QYXRoIGZpbGUsIG9wdGlvbnNcclxuXHJcbiAgICBkaXJuYW1lID0gcGF0aC5kaXJuYW1lIG91dEZpbGVcclxuICAgIHVubGVzcyBmcy5leGlzdHNTeW5jIGRpcm5hbWVcclxuICAgICAgd3JlbmNoLm1rZGlyU3luY1JlY3Vyc2l2ZSBkaXJuYW1lLCAwbzA3NzdcclxuXHJcbiAgICBmcy53cml0ZUZpbGUgb3V0RmlsZSwgZGF0YSwgKGVycikgLT5cclxuICAgICAgaWYgZXJyXHJcbiAgICAgICAgbG9nIFwiZXJyb3JcIiwgXCJFcnJvciByZWFkaW5nIGZpbGUgW1sgI3tmaWxlfSBdXSwgI3tlcnJ9XCJcclxuICAgICAgZWxzZVxyXG4gICAgICAgIGxvZyBcInN1Y2Nlc3NcIiwgXCJGaWxlIGNvcGllZCB0byBkZXN0aW5hdGlvbiBbWyAje291dEZpbGV9IF1dLlwiXHJcblxyXG5kZWxldGVGaWxlU3luYyA9IChmaWxlKSAtPlxyXG4gIGlmIGZzLmV4aXN0c1N5bmMgZmlsZVxyXG4gICAgZnMudW5saW5rU3luYyBmaWxlXHJcbiAgICBsb2cgXCJzdWNjZXNzXCIsIFwiRmlsZSBbWyAje2ZpbGV9IF1dIGRlbGV0ZWQuXCJcclxuXHJcbmRlbGV0ZUZpbGUgPSAoZmlsZSkgLT5cclxuICBmcy5leGlzdHMgZmlsZSwgKGV4aXN0cykgLT5cclxuICAgIGlmIGV4aXN0c1xyXG4gICAgICBmcy51bmxpbmsgZmlsZSwgKGVycikgLT5cclxuICAgICAgICBpZiBlcnJcclxuICAgICAgICAgIGxvZyBcImVycm9yXCIsIFwiRXJyb3IgZGVsZXRpbmcgZmlsZSBbWyAje2ZpbGV9IF1dLCAje2Vycn1cIlxyXG4gICAgICAgIGVsc2VcclxuICAgICAgICAgIGxvZyBcInN1Y2Nlc3NcIiwgXCJGaWxlIFtbICN7ZmlsZX0gXV0gZGVsZXRlZC5cIlxyXG5cclxuZGVsZXRlRGlyZWN0b3J5ID0gKGRpciwgY2IpIC0+XHJcbiAgaWYgZnMuZXhpc3RzU3luYyBkaXJcclxuICAgIGZzLnJtZGlyIGRpciwgKGVycikgLT5cclxuICAgICAgaWYgZXJyPy5jb2RlIGlzIG5vdCBcIkVOT1RFTVBUWVwiXHJcbiAgICAgICAgbG9nIFwiZXJyb3JcIiwgXCJVbmFibGUgdG8gZGVsZXRlIGRpcmVjdG9yeSBbWyAje2Rpcn0gXV1cIlxyXG4gICAgICAgIGxvZyBcImVycm9yXCIsIGVyclxyXG4gICAgICBlbHNlXHJcbiAgICAgICAgbG9nIFwiaW5mb1wiLCBcIkRlbGV0ZWQgZW1wdHkgZGlyZWN0b3J5IFtbICN7ZGlyfSBdXVwiXHJcbiAgICAgIGNiKCkgaWYgY2JcclxuICBlbHNlIGNiKCkgaWYgY2JcclxuXHJcbnRyYW5zZm9ybVBhdGggPSAoZmlsZSwge3NvdXJjZURpciwgY29udmVudGlvbnN9KSAtPlxyXG4gIHJlc3VsdCA9IF8ucmVkdWNlKGNvbnZlbnRpb25zLCAoYWNjLCB7bWF0Y2gsIHRyYW5zZm9ybX0pIC0+XHJcbiAgICBleHQgPSBwYXRoLmV4dG5hbWUgYWNjXHJcbiAgICBpZiBtYXRjaCBhY2MsIGV4dCB0aGVuIHRyYW5zZm9ybSBhY2MsIHBhdGggZWxzZSBhY2NcclxuICAsIGZpbGUpXHJcbiAgcGF0aC5qb2luIHNvdXJjZURpciwgcmVzdWx0XHJcblxyXG5leGNsdWRlU3RyYXRlZ2llcyA9XHJcbiAgc3RyaW5nOlxyXG4gICAgaWRlbnRpdHk6IF8uaXNTdHJpbmdcclxuICAgIHByZWRpY2F0ZTogKGV4LCBwYXRoKSAtPiBwYXRoLmluZGV4T2YoZXgpID09IDBcclxuICByZWdleDpcclxuICAgIGlkZW50aXR5OiBfLmlzUmVnRXhwXHJcbiAgICBwcmVkaWNhdGU6IChleCwgcGF0aCkgLT4gZXgudGVzdCBwYXRoXHJcblxyXG5pc0V4Y2x1ZGVkQnlDb25maWcgPSAocGF0aCwgZXhjbHVkZXMpIC0+XHJcbiAgb2ZUeXBlID0gKG1ldGhvZCkgLT5cclxuICAgIGV4Y2x1ZGVzLmZpbHRlciAoZikgLT4gbWV0aG9kKGYpXHJcblxyXG4gIF8uYW55IGV4Y2x1ZGVTdHJhdGVnaWVzLCAoe2lkZW50aXR5LCBwcmVkaWNhdGV9KSAtPlxyXG4gICAgXy5hbnkgKG9mVHlwZSBpZGVudGl0eSksIChleCkgLT4gcHJlZGljYXRlIGV4LCBwYXRoXHJcblxyXG5wYXJzZVhtbCA9IChmaWxlUGF0aCkgLT5cclxuICBjb250ZW50cyA9IGZzLnJlYWRGaWxlU3luYyBmaWxlUGF0aFxyXG4gIHJlc3VsdCA9IHt9XHJcbiAgcGFyc2VTdHJpbmcgY29udGVudHMsIChlcnIsIG91dHB1dCkgLT5cclxuICAgIHJlc3VsdCA9IG91dHB1dFxyXG4gIHJlc3VsdFxyXG5cclxuYnVpbGRFeHRlbnNpb25zID0gKGNvbmZpZykgLT5cclxuICB7Y29weSwgamF2YXNjcmlwdCwgY3NzfSA9IGNvbmZpZy5leHRlbnNpb25zXHJcbiAgZXh0ZW5zaW9ucyA9IF8udW5pb24gY29weSwgamF2YXNjcmlwdCwgY3NzXHJcblxyXG5pbXBvcnRBc3NldHMgPSAobWltb3NhQ29uZmlnLCBvcHRpb25zLCBuZXh0KSAtPlxyXG4gIHtleGNsdWRlUGF0aHMsIHNvdXJjZURpciwgY29tcGlsZWREaXIsIGlzQnVpbGQsIGNvbnZlbnRpb25zfSA9XHJcbiAgICBtaW1vc2FDb25maWcuZnVidW12Y1xyXG5cclxuICBleHRlbnNpb25zID0gYnVpbGRFeHRlbnNpb25zIG1pbW9zYUNvbmZpZ1xyXG5cclxuICBsb2cgXCJkZWJ1Z1wiLCBcImltcG9ydGluZyBhc3NldHNcIlxyXG4gIGxvZyBcImRlYnVnXCIsIFwiYWxsb3dlZCBleHRlbnNpb25zIFtbICN7ZXh0ZW5zaW9uc30gXV1cIlxyXG4gIGxvZyBcImRlYnVnXCIsIFwiZXhjbHVkZVBhdGhzIFtbICN7ZXhjbHVkZVBhdGhzfSBdXVwiXHJcblxyXG4gIGZpbGVXYXRjaGVyID0gcHJlcGFyZUZpbGVXYXRjaGVyIGN3ZCwgZXh0ZW5zaW9ucywgZXhjbHVkZVBhdGhzLCBpc0J1aWxkXHJcbiAgc3RhcnRXYXRjaGluZyBjd2QsIGZpbGVXYXRjaGVyLCB7c291cmNlRGlyLCBjb252ZW50aW9uc30sIG5leHRcclxuICAjVE9ETzogZ2F0aGVyIHNvdXJjZXNcclxuICAjLmxpbmtzLCB3aWxsIHVzZSBwYXJzZVhtbCBmb3IgdGhpc1xyXG4gICNcclxuXHJcbmNsZWFuQXNzZXRzID0gKG1pbW9zYUNvbmZpZywgb3B0aW9ucywgbmV4dCkgLT5cclxuICB7ZXh0ZW5zaW9ucywgZXhjbHVkZVBhdGhzLCBzb3VyY2VEaXIsIGNvbXBpbGVkRGlyLCBpc0J1aWxkLCBjb252ZW50aW9uc30gPVxyXG4gICAgbWltb3NhQ29uZmlnLmZ1YnVtdmNcclxuICBleHRlbnNpb25zID0gYnVpbGRFeHRlbnNpb25zIG1pbW9zYUNvbmZpZ1xyXG4gIG9wdGlvbnMgPSB7c291cmNlRGlyLCBjb252ZW50aW9uc31cclxuXHJcbiAgZmlsZXMgID0gZmluZFNvdXJjZUZpbGVzIGN3ZCwgZXh0ZW5zaW9ucywgZXhjbHVkZVBhdGhzXHJcbiAgb3V0cHV0RmlsZXMgPSBfLm1hcCBmaWxlcywgKGYpIC0+IHRyYW5zZm9ybVBhdGggZiwgb3B0aW9uc1xyXG5cclxuICBfLmVhY2ggb3V0cHV0RmlsZXMsIChmKSAtPiBkZWxldGVGaWxlU3luYyBmXHJcblxyXG4gIGRpcnMgPSBfIGZpbGVzXHJcbiAgICAubWFwIChmKSAtPiB0cmFuc2Zvcm1QYXRoIGYsIG9wdGlvbnNcclxuICAgIC5tYXAgKGYpIC0+IHBhdGguZGlybmFtZSBmXHJcbiAgICAuc29ydEJ5IFwibGVuZ3RoXCJcclxuICAgIC5yZXZlcnNlKClcclxuICAgIC52YWx1ZSgpXHJcblxyXG4gIHJlbWFpbmluZ0RpcnMgPSBbXS5jb25jYXQgZGlyc1xyXG4gIGRvbmUgPSAoZGlyKSAtPlxyXG4gICAgcmVtYWluaW5nRGlycyA9IF8ud2l0aG91dCByZW1haW5pbmdEaXJzLCBkaXJcclxuICAgIGlmIHJlbWFpbmluZ0RpcnMubGVuZ3RoID09IDBcclxuICAgICAgbmV4dCgpXHJcblxyXG4gIF8gZGlyc1xyXG4gICAgLm1hcCAoZGlyKSAtPiBbZGlyLCAoKSAtPiBkb25lKGRpcildXHJcbiAgICAuZWFjaCAoW2RpciwgY2JdKSAtPlxyXG4gICAgICBkZWxldGVEaXJlY3RvcnkgZGlyLCBjYlxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSB7aW1wb3J0QXNzZXRzLCBjbGVhbkFzc2V0c31cclxuIl19
