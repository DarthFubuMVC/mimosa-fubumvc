"use strict";
var Bliss, Rx, bliss, cleanAssets, copyContents, cwd, excludeStrategies, findSourceFiles, fs, importAssets, initFiles, isExcludedByConfig, logger, makeFolders, makeOptions, mkdirp, parseString, parseXml, path, prepareFileWatcher, relativeToThisFile, setupFileSystem, shouldInclude, startCopying, watch, wrench, _;

fs = require('fs');

path = require('path');

watch = require('chokidar');

wrench = require('wrench');

logger = require('logmimosa');

_ = require('lodash');

mkdirp = require('mkdirp');

parseString = require('xml2js').parseString;

Bliss = require('bliss');

bliss = new Bliss({
  ext: ".bliss",
  cacheEnabled: false,
  context: {}
});

cwd = process.cwd();

Rx = require("rx");

importAssets = function(mimosaConfig, options, next) {
  var excludes, extensions, sourceFiles;
  extensions = mimosaConfig.extensions.copy;
  excludes = mimosaConfig.fubumvc.excludePaths;
  sourceFiles = findSourceFiles(cwd, extensions, excludes);
  logger.info(sourceFiles);
  return next();
};

cleanAssets = function(mimosaConfig, options, next) {
  return next();
};

findSourceFiles = function(from, extensions, excludes) {
  return wrench.readdirSyncRecursive(from).filter(function(f) {
    var isFile, isIncluded;
    isIncluded = shouldInclude(f, extensions, excludes);
    isFile = fs.statSync(f).isFile();
    return isIncluded && isFile;
  });
};

shouldInclude = function(f, extensions, excludes) {
  var atRoot, excluded, matchesExtension;
  extensions = extensions.map(function(ext) {
    return "." + ext;
  });
  atRoot = f.indexOf(path.sep) === -1;
  matchesExtension = _.contains(extensions, path.extname(f));
  excluded = isExcludedByConfig(f, excludes);
  return matchesExtension && !excluded && !atRoot;
};

prepareFileWatcher = function(from, extensions, excludes) {
  var adds, changes, errors, files, numberOfFiles, unlinks, watchSettings, watcher;
  files = findSourceFiles(from, extensions, excludes);
  numberOfFiles = files.length;
  watchSettings = {
    ignored: function(file) {
      var isDirectory;
      isDirectory = fs.statSync(file).isDirectory();
      if (isDirectory) {
        return false;
      } else {
        return !(shouldInclude(file, extensions, excludes));
      }
    },
    pesistent: false,
    usePolling: true,
    interval: 500,
    binaryInterval: 1000
  };
  watcher = watch.watch(from, watchSettings);
  adds = Rx.Observable.fromEvent(watcher, "add");
  changes = Rx.Observable.fromEvent(watcher, "change");
  unlinks = Rx.Observable.fromEvent(watcher, "unlink");
  errors = (Rx.Observable.fromEvent(watcher, "error")).selectMany(function(e) {
    return Rx.Observable.Throw(e);
  });
  return {
    numberOfFiles: numberOfFiles,
    adds: adds,
    changes: changes,
    unlinks: unlinks,
    errors: errors
  };
};

startCopying = function(from, extensions, excludes, cb) {
  var adds, changes, errors, initialCopy, numberOfFiles, ongoingCopy, unlinks, withoutFromPath, _ref;
  _ref = prepareFileWatcher(from, extensions, excludes), numberOfFiles = _ref.numberOfFiles, adds = _ref.adds, changes = _ref.changes, unlinks = _ref.unlinks, errors = _ref.errors;
  withoutFromPath = function(input) {
    return input.replace("" + from + path.sep, '');
  };
  initialCopy = adds.merge(errors).take(numberOfFiles).map(withoutFromPath);
  initialCopy.subscribe(function(f) {
    return logger.info("onNext: " + f);
  }, function(e) {
    logger.info("onError: " + e);
    if (cb) {
      return cb();
    }
  }, function() {
    logger.info("onCompleted");
    if (cb) {
      return cb();
    }
  });
  ongoingCopy = adds.merge(changes).merge(errors).map(withoutFromPath);
  return ongoingCopy.subscribe(function(f) {
    return logger.info("onNext: " + f);
  }, function(e) {
    return logger.info("onError: " + e);
  }, function() {
    return logger.info("onCompleted");
  });
};

excludeStrategies = {
  string: {
    identity: _.isString,
    predicate: function(ex, path) {
      return path.indexOf(ex) === 0;
    }
  },
  regex: {
    identity: _.isRegExp,
    predicate: function(ex, path) {
      return ex.test(path);
    }
  }
};

isExcludedByConfig = function(path, excludes) {
  var ofType;
  ofType = function(method) {
    return excludes.filter(function(f) {
      return method(f);
    });
  };
  return _.any(excludeStrategies, function(_arg) {
    var identity, predicate;
    identity = _arg.identity, predicate = _arg.predicate;
    return _.any(ofType(identity), function(ex) {
      return predicate(ex, path);
    });
  });
};

relativeToThisFile = function(filePath, dirname) {
  if (dirname == null) {
    dirname = __dirname;
  }
  return path.join(dirname, filePath);
};

setupFileSystem = function(args) {
  makeFolders();
  return initFiles(args);
};

makeFolders = function() {
  var folders;
  folders = ['assets/scripts', 'assets/styles', 'public'];
  return _.each(folders, function(dir) {
    logger.info("making sure " + dir + " exists");
    return mkdirp.sync(dir, function(err) {
      return logger.error(err);
    });
  });
};

makeOptions = function() {
  var options;
  return options = {
    name: path.basename(cwd)
  };
};

initFiles = function(flags) {
  var contents, ext, fileWithContents, files, options, pair, useCoffee, _i, _len;
  if (flags == null) {
    flags = false;
  }
  useCoffee = flags === "coffee";
  options = makeOptions();
  ext = useCoffee ? "coffee" : "js";
  files = ["bower.json", "mimosa-config." + ext];
  contents = _(files).map(function(f) {
    return relativeToThisFile("../fubu-import-templates/" + f);
  }).map(function(f) {
    return bliss.render(f, options);
  }).map(function(f) {
    return f.trim();
  }).value();
  fileWithContents = _.zip(files, contents);
  for (_i = 0, _len = fileWithContents.length; _i < _len; _i++) {
    pair = fileWithContents[_i];
    copyContents(pair);
  }
};

copyContents = function(_arg) {
  var contents, fileName;
  fileName = _arg[0], contents = _arg[1];
  if (!fs.existsSync(fileName)) {
    logger.info("creating " + fileName);
    return fs.writeFileSync(fileName, contents);
  }
};

parseXml = function(filePath) {
  var contents, result;
  contents = fs.readFileSync(filePath);
  result = {};
  parseString(contents, function(err, output) {
    return result = output;
  });
  return result;
};

module.exports = {
  importAssets: importAssets,
  cleanAssets: cleanAssets,
  setupFileSystem: setupFileSystem
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYzpcXGhvbWVcXGdpdGh1YlxcbWltb3NhLWZ1YnVtdmNcXGxpYlxcZnVidS1pbXBvcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjOlxcaG9tZVxcZ2l0aHViXFxtaW1vc2EtZnVidW12Y1xcc3JjXFxmdWJ1LWltcG9ydC5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBQSxDQUFBO0FBQUEsSUFBQSxvVEFBQTs7QUFBQSxFQUVBLEdBQUssT0FBQSxDQUFRLElBQVIsQ0FGTCxDQUFBOztBQUFBLElBR0EsR0FBTyxPQUFBLENBQVEsTUFBUixDQUhQLENBQUE7O0FBQUEsS0FJQSxHQUFRLE9BQUEsQ0FBUSxVQUFSLENBSlIsQ0FBQTs7QUFBQSxNQUtBLEdBQVMsT0FBQSxDQUFRLFFBQVIsQ0FMVCxDQUFBOztBQUFBLE1BTUEsR0FBUyxPQUFBLENBQVEsV0FBUixDQU5ULENBQUE7O0FBQUEsQ0FPQSxHQUFJLE9BQUEsQ0FBUSxRQUFSLENBUEosQ0FBQTs7QUFBQSxNQVFBLEdBQVMsT0FBQSxDQUFRLFFBQVIsQ0FSVCxDQUFBOztBQUFBLFdBU0EsR0FBYyxPQUFBLENBQVEsUUFBUixDQUFpQixDQUFDLFdBVGhDLENBQUE7O0FBQUEsS0FVQSxHQUFRLE9BQUEsQ0FBUSxPQUFSLENBVlIsQ0FBQTs7QUFBQSxLQVdBLEdBQVksSUFBQSxLQUFBLENBQ1Y7QUFBQSxFQUFBLEdBQUEsRUFBSyxRQUFMO0FBQUEsRUFDQSxZQUFBLEVBQWMsS0FEZDtBQUFBLEVBRUEsT0FBQSxFQUFTLEVBRlQ7Q0FEVSxDQVhaLENBQUE7O0FBQUEsR0FlQSxHQUFNLE9BQU8sQ0FBQyxHQUFSLENBQUEsQ0FmTixDQUFBOztBQUFBLEVBZ0JBLEdBQUssT0FBQSxDQUFRLElBQVIsQ0FoQkwsQ0FBQTs7QUFBQSxZQWtCQSxHQUFlLFNBQUMsWUFBRCxFQUFlLE9BQWYsRUFBd0IsSUFBeEIsR0FBQTtBQUNiLE1BQUEsaUNBQUE7QUFBQSxFQUFBLFVBQUEsR0FBYSxZ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LEVBQUMsY0FBQSxZQUFEO0FBQUEsRUFBZSxhQUFBLFdBQWY7QUFBQSxFQUE0QixpQkFBQSxlQUE1QjtDQTlLakIsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiXHJcblxyXG5mcyA9IHJlcXVpcmUgJ2ZzJ1xyXG5wYXRoID0gcmVxdWlyZSAncGF0aCdcclxud2F0Y2ggPSByZXF1aXJlICdjaG9raWRhcidcclxud3JlbmNoID0gcmVxdWlyZSAnd3JlbmNoJ1xyXG5sb2dnZXIgPSByZXF1aXJlICdsb2dtaW1vc2EnXHJcbl8gPSByZXF1aXJlICdsb2Rhc2gnXHJcbm1rZGlycCA9IHJlcXVpcmUgJ21rZGlycCdcclxucGFyc2VTdHJpbmcgPSByZXF1aXJlKCd4bWwyanMnKS5wYXJzZVN0cmluZ1xyXG5CbGlzcyA9IHJlcXVpcmUgJ2JsaXNzJ1xyXG5ibGlzcyA9IG5ldyBCbGlzc1xyXG4gIGV4dDogXCIuYmxpc3NcIlxyXG4gIGNhY2hlRW5hYmxlZDogZmFsc2UsXHJcbiAgY29udGV4dDoge31cclxuY3dkID0gcHJvY2Vzcy5jd2QoKVxyXG5SeCA9IHJlcXVpcmUgXCJyeFwiXHJcblxyXG5pbXBvcnRBc3NldHMgPSAobWltb3NhQ29uZmlnLCBvcHRpb25zLCBuZXh0KSAtPlxyXG4gIGV4dGVuc2lvbnMgPSBtaW1vc2FDb25maWcuZXh0ZW5zaW9ucy5jb3B5XHJcbiAgZXhjbHVkZXMgPSBtaW1vc2FDb25maWcuZnVidW12Yy5leGNsdWRlUGF0aHNcclxuICBzb3VyY2VGaWxlcyA9IGZpbmRTb3VyY2VGaWxlcyBjd2QsIGV4dGVuc2lvbnMsIGV4Y2x1ZGVzXHJcbiAgbG9nZ2VyLmluZm8gc291cmNlRmlsZXNcclxuICAjVE9ETzogZ2F0aGVyIHNvdXJjZXNcclxuICAjLmxpbmtzLCB3aWxsIHVzZSBwYXJzZVhtbCBmb3IgdGhpc1xyXG4gICNmdWJ1LWNvbnRlbnRcclxuICAjc291cmNlIGRpciAoaW5jbHVkaW5nIGNvbnRlbnQpXHJcbiAgbmV4dCgpXHJcblxyXG5jbGVhbkFzc2V0cyA9IChtaW1vc2FDb25maWcsIG9wdGlvbnMsIG5leHQpIC0+XHJcbiAgbmV4dCgpXHJcblxyXG5maW5kU291cmNlRmlsZXMgPSAoZnJvbSwgZXh0ZW5zaW9ucywgZXhjbHVkZXMpIC0+XHJcbiAgd3JlbmNoLnJlYWRkaXJTeW5jUmVjdXJzaXZlKGZyb20pXHJcbiAgICAuZmlsdGVyIChmKSAtPlxyXG4gICAgICBpc0luY2x1ZGVkID0gc2hvdWxkSW5jbHVkZSBmLCBleHRlbnNpb25zLCBleGNsdWRlc1xyXG4gICAgICBpc0ZpbGUgPSBmcy5zdGF0U3luYyhmKS5pc0ZpbGUoKVxyXG4gICAgICBpc0luY2x1ZGVkIGFuZCBpc0ZpbGVcclxuXHJcbnNob3VsZEluY2x1ZGUgPSAoZiwgZXh0ZW5zaW9ucywgZXhjbHVkZXMpIC0+XHJcbiAgI1RPRE86IG9ubHkgYWRkcyB0aGUgLiB0byB5b3UgZm9yIGV4dGVuc2lvbnMgaWYgaXRzIGxlZnQgb2ZmXHJcbiAgZXh0ZW5zaW9ucyA9IGV4dGVuc2lvbnMubWFwIChleHQpIC0+IFwiLiN7ZXh0fVwiXHJcbiAgYXRSb290ID0gZi5pbmRleE9mKHBhdGguc2VwKSA9PSAtMVxyXG4gIG1hdGNoZXNFeHRlbnNpb24gPSBfLmNvbnRhaW5zIGV4dGVuc2lvbnMsIHBhdGguZXh0bmFtZSBmXHJcbiAgZXhjbHVkZWQgPSBpc0V4Y2x1ZGVkQnlDb25maWcgZiwgZXhjbHVkZXNcclxuICBtYXRjaGVzRXh0ZW5zaW9uIGFuZCBub3QgZXhjbHVkZWQgYW5kIG5vdCBhdFJvb3RcclxuXHJcbnByZXBhcmVGaWxlV2F0Y2hlciA9IChmcm9tLCBleHRlbnNpb25zLCBleGNsdWRlcykgLT5cclxuICBmaWxlcyAgPSBmaW5kU291cmNlRmlsZXMgZnJvbSwgZXh0ZW5zaW9ucywgZXhjbHVkZXNcclxuICBudW1iZXJPZkZpbGVzICA9IGZpbGVzLmxlbmd0aFxyXG5cclxuICB3YXRjaFNldHRpbmdzID1cclxuICAgIGlnbm9yZWQ6IChmaWxlKSAtPlxyXG4gICAgICBpc0RpcmVjdG9yeSA9IGZzLnN0YXRTeW5jKGZpbGUpLmlzRGlyZWN0b3J5KClcclxuICAgICAgaWYgaXNEaXJlY3RvcnlcclxuICAgICAgICBmYWxzZVxyXG4gICAgICBlbHNlXHJcbiAgICAgICAgbm90IChzaG91bGRJbmNsdWRlIGZpbGUsIGV4dGVuc2lvbnMsIGV4Y2x1ZGVzKVxyXG4gICAgcGVzaXN0ZW50OiBmYWxzZVxyXG4gICAgdXNlUG9sbGluZzogdHJ1ZVxyXG4gICAgaW50ZXJ2YWw6IDUwMFxyXG4gICAgYmluYXJ5SW50ZXJ2YWw6IDEwMDBcclxuXHJcbiAgd2F0Y2hlciA9IHdhdGNoLndhdGNoIGZyb20sIHdhdGNoU2V0dGluZ3NcclxuICBhZGRzID0gUnguT2JzZXJ2YWJsZS5mcm9tRXZlbnQgd2F0Y2hlciwgXCJhZGRcIlxyXG4gIGNoYW5nZXMgPSBSeC5PYnNlcnZhYmxlLmZyb21FdmVudCB3YXRjaGVyLCBcImNoYW5nZVwiXHJcbiAgdW5saW5rcyA9IFJ4Lk9ic2VydmFibGUuZnJvbUV2ZW50IHdhdGNoZXIsIFwidW5saW5rXCJcclxuICBlcnJvcnMgPSAoUnguT2JzZXJ2YWJsZS5mcm9tRXZlbnQgd2F0Y2hlciwgXCJlcnJvclwiKS5zZWxlY3RNYW55IChlKSAtPiBSeC5PYnNlcnZhYmxlLlRocm93IGVcclxuICB7bnVtYmVyT2ZGaWxlcywgYWRkcywgY2hhbmdlcywgdW5saW5rcywgZXJyb3JzfVxyXG5cclxuc3RhcnRDb3B5aW5nID0gKGZyb20sIGV4dGVuc2lvbnMsIGV4Y2x1ZGVzLCBjYikgLT5cclxuICB7bnVtYmVyT2ZGaWxlcywgYWRkcywgY2hhbmdlcywgdW5saW5rcywgZXJyb3JzfSA9XHJcbiAgICBwcmVwYXJlRmlsZVdhdGNoZXIgZnJvbSwgZXh0ZW5zaW9ucywgZXhjbHVkZXNcclxuXHJcbiAgd2l0aG91dEZyb21QYXRoID0gKGlucHV0KSAtPlxyXG4gICAgaW5wdXQucmVwbGFjZSBcIiN7ZnJvbX0je3BhdGguc2VwfVwiLCAnJ1xyXG5cclxuICBpbml0aWFsQ29weSA9IGFkZHNcclxuICAgIC5tZXJnZShlcnJvcnMpXHJcbiAgICAudGFrZShudW1iZXJPZkZpbGVzKVxyXG4gICAgLm1hcCB3aXRob3V0RnJvbVBhdGhcclxuXHJcbiAgaW5pdGlhbENvcHkuc3Vic2NyaWJlKFxyXG4gICAgKGYpIC0+XHJcbiAgICAgIGxvZ2dlci5pbmZvIFwib25OZXh0OiAje2Z9XCJcclxuICAgIChlKSAtPlxyXG4gICAgICBsb2dnZXIuaW5mbyBcIm9uRXJyb3I6ICN7ZX1cIlxyXG4gICAgICBjYigpIGlmIGNiXHJcbiAgICAoKSAtPlxyXG4gICAgICBsb2dnZXIuaW5mbyBcIm9uQ29tcGxldGVkXCJcclxuICAgICAgY2IoKSBpZiBjYlxyXG4gIClcclxuXHJcbiAgb25nb2luZ0NvcHkgPSBhZGRzXHJcbiAgICAubWVyZ2UoY2hhbmdlcylcclxuICAgIC5tZXJnZShlcnJvcnMpXHJcbiAgICAubWFwIHdpdGhvdXRGcm9tUGF0aFxyXG5cclxuICBvbmdvaW5nQ29weS5zdWJzY3JpYmUoXHJcbiAgICAoZikgLT5cclxuICAgICAgbG9nZ2VyLmluZm8gXCJvbk5leHQ6ICN7Zn1cIlxyXG4gICAgKGUpIC0+XHJcbiAgICAgIGxvZ2dlci5pbmZvIFwib25FcnJvcjogI3tlfVwiXHJcbiAgICAoKSAtPlxyXG4gICAgICBsb2dnZXIuaW5mbyBcIm9uQ29tcGxldGVkXCJcclxuICApXHJcblxyXG4gICNmaWxlc1RvRGVsZXRlID0gdW5saW5rc1xyXG4gICMgIC5tZXJnZShlcnJvcnMpXHJcbiAgIyAgLm1hcCAoZikgLT4gcGF0aC5iYXNlbmFtZSBmXHJcblxyXG5leGNsdWRlU3RyYXRlZ2llcyA9XHJcbiAgc3RyaW5nOlxyXG4gICAgaWRlbnRpdHk6IF8uaXNTdHJpbmdcclxuICAgIHByZWRpY2F0ZTogKGV4LCBwYXRoKSAtPiBwYXRoLmluZGV4T2YoZXgpID09IDBcclxuICByZWdleDpcclxuICAgIGlkZW50aXR5OiBfLmlzUmVnRXhwXHJcbiAgICBwcmVkaWNhdGU6IChleCwgcGF0aCkgLT4gZXgudGVzdCBwYXRoXHJcblxyXG5pc0V4Y2x1ZGVkQnlDb25maWcgPSAocGF0aCwgZXhjbHVkZXMpIC0+XHJcbiAgb2ZUeXBlID0gKG1ldGhvZCkgLT5cclxuICAgIGV4Y2x1ZGVzLmZpbHRlciAoZikgLT4gbWV0aG9kKGYpXHJcblxyXG4gIF8uYW55IGV4Y2x1ZGVTdHJhdGVnaWVzLCAoe2lkZW50aXR5LCBwcmVkaWNhdGV9KSAtPlxyXG4gICAgXy5hbnkgKG9mVHlwZSBpZGVudGl0eSksIChleCkgLT4gcHJlZGljYXRlIGV4LCBwYXRoXHJcblxyXG5yZWxhdGl2ZVRvVGhpc0ZpbGUgPSAoZmlsZVBhdGgsIGRpcm5hbWUpIC0+XHJcbiAgZGlybmFtZSA/PSBfX2Rpcm5hbWVcclxuICBwYXRoLmpvaW4gZGlybmFtZSwgZmlsZVBhdGhcclxuXHJcbnNldHVwRmlsZVN5c3RlbSA9IChhcmdzKSAtPlxyXG4gIG1ha2VGb2xkZXJzKClcclxuICBpbml0RmlsZXMoYXJncylcclxuXHJcbm1ha2VGb2xkZXJzID0gLT5cclxuICBmb2xkZXJzID0gWydhc3NldHMvc2NyaXB0cycsICdhc3NldHMvc3R5bGVzJywgJ3B1YmxpYyddXHJcbiAgXy5lYWNoIGZvbGRlcnMsIChkaXIpIC0+XHJcbiAgICBsb2dnZXIuaW5mbyBcIm1ha2luZyBzdXJlICN7ZGlyfSBleGlzdHNcIlxyXG4gICAgbWtkaXJwLnN5bmMgZGlyLCAoZXJyKSAtPlxyXG4gICAgICBsb2dnZXIuZXJyb3IoZXJyKVxyXG5cclxubWFrZU9wdGlvbnMgPSAtPlxyXG4gIG9wdGlvbnMgPVxyXG4gICAgbmFtZTogcGF0aC5iYXNlbmFtZSBjd2RcclxuXHJcbmluaXRGaWxlcyA9IChmbGFncyA9IGZhbHNlKSAtPlxyXG4gIHVzZUNvZmZlZSA9IGZsYWdzID09IFwiY29mZmVlXCJcclxuICBvcHRpb25zID0gbWFrZU9wdGlvbnMoKVxyXG4gIGV4dCA9IGlmIHVzZUNvZmZlZSB0aGVuIFwiY29mZmVlXCIgZWxzZSBcImpzXCJcclxuICBmaWxlcyA9IFtcImJvd2VyLmpzb25cIiwgXCJtaW1vc2EtY29uZmlnLiN7ZXh0fVwiXVxyXG4gIGNvbnRlbnRzID0gXyBmaWxlc1xyXG4gICAgLm1hcCAoZikgLT4gcmVsYXRpdmVUb1RoaXNGaWxlIFwiLi4vZnVidS1pbXBvcnQtdGVtcGxhdGVzLyN7Zn1cIlxyXG4gICAgLm1hcCAoZikgLT4gYmxpc3MucmVuZGVyIGYsIG9wdGlvbnNcclxuICAgIC5tYXAgKGYpIC0+IGYudHJpbSgpXHJcbiAgICAudmFsdWUoKVxyXG4gIGZpbGVXaXRoQ29udGVudHMgPSBfLnppcChmaWxlcywgY29udGVudHMpXHJcblxyXG4gIGNvcHlDb250ZW50cyBwYWlyIGZvciBwYWlyIGluIGZpbGVXaXRoQ29udGVudHNcclxuICAjYXZvaWQgcmV0dXJuaW5nIGFuIGFycmF5IG9mIG5vdGhpbmcgd2hlbiB1c2luZyBhIGNvbXByZWhlbnNpb24gYXMgeW91ciBsYXN0IGxpbmVcclxuICAjYnkgdXNpbmcgYW4gZXhwbGljaXQgcmV0dXJuXHJcbiAgcmV0dXJuXHJcblxyXG5jb3B5Q29udGVudHMgPSAoW2ZpbGVOYW1lLCBjb250ZW50c10pIC0+XHJcbiAgdW5sZXNzIGZzLmV4aXN0c1N5bmMgZmlsZU5hbWVcclxuICAgIGxvZ2dlci5pbmZvIFwiY3JlYXRpbmcgI3tmaWxlTmFtZX1cIlxyXG4gICAgZnMud3JpdGVGaWxlU3luYyBmaWxlTmFtZSwgY29udGVudHNcclxuXHJcbnBhcnNlWG1sID0gKGZpbGVQYXRoKSAtPlxyXG4gIGNvbnRlbnRzID0gZnMucmVhZEZpbGVTeW5jIGZpbGVQYXRoXHJcbiAgcmVzdWx0ID0ge31cclxuICBwYXJzZVN0cmluZyBjb250ZW50cywgKGVyciwgb3V0cHV0KSAtPlxyXG4gICAgcmVzdWx0ID0gb3V0cHV0XHJcbiAgcmVzdWx0XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IHtpbXBvcnRBc3NldHMsIGNsZWFuQXNzZXRzLCBzZXR1cEZpbGVTeXN0ZW19XHJcbiJdfQ==
